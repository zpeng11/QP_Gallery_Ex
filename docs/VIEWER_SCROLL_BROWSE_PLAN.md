# 大图滚动浏览两阶段实施计划

## 背景与目标
当前大图浏览模式以横向翻页触发为主，用户切换图片时有明显“分页感”。  
目标是分两步演进到“更接近长网页”的浏览体验：

- **阶段 1**：先提供可开关的竖向滚动式浏览交互，降低切换割裂感，并与旧逻辑兼容。
- **阶段 2**：实现真正的多图竖向连续流（可同屏多张、无分页切换感、相册内持续滚动）。

## 范围与非目标
### 范围
- 大图查看模式（viewer）的交互与渲染路径。
- 设置项新增与配置读取。
- 与相册索引（上一张/下一张）联动。

### 非目标
- 不改动缩略图页（album/grid）布局与排序逻辑。
- 不改变已有图片编辑、分享、删除等业务动作入口。
- 阶段 1 不实现“多图同屏连续渲染”。

## 阶段 1：滚动交互开关（已落地）
### 目标
在不重构 viewer 渲染架构的前提下，提供“可选的竖向滚动式浏览”，并保留默认行为。

### 设计
- 新增设置开关：`viewer_scroll_browse`（默认 `false`）。
- 开关开启后：
1. 禁用左右边界触发的横向翻页。
2. 竖向 fling 手势触发相册索引切换（上一张/下一张）。
- 开关关闭后：保持原横向翻页逻辑。

### 代码落点（阶段 1）
- 资源与设置项：
  - `decoded/res/xml/main_pref.xml`
  - `decoded/res/xml-v28/main_pref.xml`
  - `decoded/res/xml-v33/main_pref.xml`
  - `decoded/res/values/strings.xml`
  - `decoded/res/values-zh/strings.xml`
- 手势与翻页控制：
  - `decoded/smali/com/alensw/ui/view/bb.smali`
  - `decoded/smali/com/alensw/ui/c/be.smali`
  - `decoded/smali/com/alensw/ui/c/eb.smali`
- 补丁文件：
  - `patches/viewer-scroll-browse.patch`

### 验收标准
- 设置页可见开关，默认关闭。
- 开关关闭：行为与历史版本一致。
- 开关开启：
1. 左右边界不再触发翻页。
2. 上下甩动可在相册内切换图片。
3. 不影响现有缩放、旋转、工具栏显示逻辑。
- 可从干净基线重放补丁并成功编译。

### 风险与控制
- 风险：竖向手势与图片缩放拖拽冲突。  
  控制：仅在速度/方向阈值满足“明确竖向 fling”时触发切图。
- 风险：旧手势习惯回归。  
  控制：保持默认关闭，用户自主开启。

## 阶段 2：长网页式连续滚动浏览（待实施）
### 目标体验
- 进入大图模式后，图片按纵向连续流展示。
- 屏幕能容纳时可同屏展示多张。
- 在同一相册内连续向下/向上滚动，无“翻页切换动画”割裂感。

### 核心架构改造
1. **容器层重构**
   - 从单 `PictureView` 渲染模型升级为纵向容器（建议 `RecyclerView` 或等价可复用容器）。
   - 每个 item 承载一张大图视图（可复用 `PictureView` 能力，或拆分轻量子类）。
2. **数据窗口与预加载**
   - 以当前位置为中心维护前后窗口（如前 2 / 后 4，可配置）。
   - 滚动时增量加载与回收，避免一次性解码全相册。
3. **多图同屏策略**
   - 根据视口高度和图片比例决定同屏铺排（完整显示优先，超长图分段渲染可后续扩展）。
4. **手势冲突治理**
   - 未放大时：纵向手势优先驱动列表滚动。
   - 单图放大后：优先图内平移；到边界再移交外层容器（nested scroll 规则）。
5. **状态保持**
   - 记录并恢复：当前相册、锚点图片、列表滚动偏移、单图变换状态（必要时）。
6. **能力兼容**
   - 详情、删除、分享、设为壁纸等动作始终作用于“当前焦点图”。

### 性能与内存要求
- 大图解码必须异步、可取消、可中断。
- 限制同时活跃的大图对象数量，滚出窗口立即释放强引用。
- 缩略预览与全分辨率分层加载，优先保证滚动流畅。

### 验收标准
- 纵向连续滚动可覆盖整个相册，不出现分页切换感。
- 在常见相册规模下无明显掉帧/卡顿/内存峰值异常。
- 旋转屏幕、后台恢复后可回到合理浏览位置。
- 与现有动作菜单、手势缩放、自动隐藏栏位行为兼容。

### 主要风险与对策
- 风险：多图并发解码导致内存抖动。  
  对策：窗口限流 + 生命周期回收 + 解码优先级队列。
- 风险：复杂手势导致误触。  
  对策：分层手势状态机，明确“图内操作”与“列表滚动”切换条件。
- 风险：重构范围大、回归面广。  
  对策：分支灰度实现，保留阶段 1 开关作为回退路径。

## 建议里程碑
- M1：阶段 2 容器原型（仅静态多图渲染 + 基础滚动）。
- M2：接入真实相册数据、窗口加载、回收策略。
- M3：手势冲突处理、动作菜单绑定焦点图。
- M4：性能调优与回归测试，默认策略评估（是否开放给全部用户）。
